version: '3'

vars:
  # VERSIONS
  GO_VERSION: '1.25'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  GOOSE_VERSION: 'v3.26.0'

  # BIN PATHS
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  GOOSE: '{{.BIN_DIR}}/goose'

  # DOCKER
  DOCKER_DIR: '{{.ROOT_DIR}}/docker'

tasks:
  # ====== LINTS & FORMATTERS ======
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    summary: |
      –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ gofumpt –∏ gci –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏.

      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        - gofumpt: –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ Go
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ Go
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ golangci-lint –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ go install.

      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci, –∏—Å–∫–ª—é—á–∞—è mocks"
    summary: |
      –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Å–µ Go-—Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º gofumpt –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
      –∏ gci –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö mocks.

      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
        - gofumpt: –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."

        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
          fi
        done
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."

        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix(github.com/olezhek28/microservices-course-olezhek-solution)" {} +
          fi
        done


  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç –ª–∏–Ω—Ç–µ—Ä golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
      –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º.
      –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ gosec (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ golangci-lint).

      –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
        - install-golangci-lint: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–Ω—Ç–µ—Ä
        - format: —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–¥ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    deps: [ install-golangci-lint ]
    vars:
      MODULES: '{{.MODULES}}'
      GOLANGCI_LINT: '{{.GOLANGCI_LINT}}'
    cmds:
      - |
        set -e
        ERR=0
        echo "üîç –õ–∏–Ω—Ç–∏–º –≤—Å–µ –º–æ–¥—É–ª–∏ ..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîç –õ–∏–Ω—Ç–∏–º $mod module"
            {{.GOLANGCI_LINT}} run $mod/... --config=.golangci.yml || ERR=1
          fi
        done
        exit $ERR


  # ====== MIGRATIONS ======
  install-migration-tools:
    desc: ""
    summary: ""
    cmds:
      - |
        [ -f {{.GOOSE}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º goose {{.GOOSE_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/pressly/goose/v3/cmd/goose@{{.GOOSE_VERSION}}
        }
    status:
      - test -x {{.GOOSE}}

  goose:create-psql:
    desc: ""
    summary: ""
    deps: [ install-migration-tools ]
    requires:
      vars: [ NAME ]
    cmds:
      - |
        {
          echo "üìù –°–æ–∑–¥–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é {{.NAME}}..."
          {{.GOOSE}} -dir db/migrations create "{{.NAME}}" sql
        }

  goose:up:
    desc: ""
    summary: ""
    deps: [ install-migration-tools ]
    dotenv: ['docker/.env']
    cmds:
      - |
        {{.GOOSE}} -dir db/migrations up


  goose:down:
    desc: "–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é"
    summary: |
      –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é.
    deps: [ install-migration-tools ]
    dotenv: ['docker/.env']
    cmds:
      - |
        {{.GOOSE}} -dir db/migrations down


  goose:status:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π"
    summary: |
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –∞ –∫–∞–∫–∏–µ –Ω–µ—Ç.
    deps: [ install-migration-tools ]
    dotenv: ['docker/.env']
    cmds:
      - |
        {{.GOOSE}} -dir db/migrations status


  # ====== BENCHMARKING & TESTING ======
  hey:download:
    desc: "Get hey tool"
    summary: "Downloads hey - http server benchmarking tool (alternative for Apache ab)"
    cmds:
      - |
        wget https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
      

  # ====== DOCKER TASKS ======
  docker-up:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ background —Ä–µ–∂–∏–º–µ"
    summary: ""
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose up -d

  docker-up-foreground:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ foreground —Ä–µ–∂–∏–º–µ (dev env)"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ foreground —Ä–µ–∂–∏–º–µ.
      –ü—Ä–∏ Ctrl+C –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose up --build

  docker-down:
    desc: "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
    summary: ""
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose down

  docker-down-volumes:
    desc: "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —É–¥–∞–ª—è–µ—Ç volumes"
    summary: ""
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose down -v

  docker-build:
    desc: "–ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑—ã"
    summary: ""
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose build --no-cache

  docker-rebuild:
    desc: "–ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤ background"
    summary: ""
    dir: "{{.DOCKER_DIR}}"
    cmds:
      - docker-compose down
      - docker-compose up --build -d

  docker-logs:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    summary: |
      –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
      –î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C.
    dir: '{{.DOCKER_DIR}}'
    cmds:
      - docker-compose logs -f

  docker-logs-app:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    summary: |
      –í—ã–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ URL Shortener –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    dir: '{{.DOCKER_DIR}}'
    cmds:
      - docker-compose logs -f app

  docker-logs-postgres:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ PostgreSQL"
    summary: |
      –í—ã–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    dir: '{{.DOCKER_DIR}}'
    cmds:
      - docker-compose logs -f postgres

  # ====== POSTGRESQL TASKS ======
  psql:
    desc: "–û—Ç–∫—Ä—ã–≤–∞–µ—Ç psql –≤ PostgreSQL"
    dir: '{{.DOCKER_DIR}}'
    summary: |
      –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL —á–µ—Ä–µ–∑ psql –∫–ª–∏–µ–Ω—Ç.
    cmds:
      - docker exec -it urlshortener_postgres sh -c "psql -U urlshortener -d urlshortener"

  # ====== APPLICATION TASKS ======
  app:provision:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
    summary: |
      –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—É—Å–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
      1. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–¥
      2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      3. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–µ
      4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏
    cmds:
      - task: format
      - task: docker-down
      - task: docker-up-foreground

  app:provision:background:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ background"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å—ã –≤ background —Ä–µ–∂–∏–º–µ.
      –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: task docker-down
    cmds:
      - task: format
      - task: docker-rebuild

  app:sh:
    desc: "–û—Ç–∫—Ä—ã–≤–∞–µ—Ç shell –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    dir: '{{.DOCKER_DIR}}'
    summary: |
      –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ shell.
    cmds:
      - docker exec -it urlshortener_app sh

  app:restart:
    desc: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
    dir: '{{.DOCKER_DIR}}'
    cmds:
      - docker-compose restart app
