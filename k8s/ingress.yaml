apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: auth-required
  namespace: urls
spec:
  forwardAuth:
    address: "http://iam-service.urls.svc.cluster.local:9092/auth/validate"
    authResponseHeaders:
      - "X-User-Id"
      - "X-Provider"
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: urls-ingress
  namespace: urls
spec:
  entryPoints:
    - web
  routes:
    # Health check endpoints (no auth)
    - match: Path(`/api/v1/health`) || Path(`/api/v1/readiness`)
      kind: Rule
      services:
        - name: urls-service
          port: 9091
      priority: 20

    # User URLs list (requires auth to get X-User-Id)
    - match: Path(`/api/v1/urls`) && Method(`GET`)
      kind: Rule
      middlewares:
        - name: auth-required
      services:
        - name: urls-service
          port: 9091
      priority: 12

    # Protected POST/DELETE requests (require auth)
    - match: PathPrefix(`/api`) && (Method(`POST`) || Method(`DELETE`) || Method(`PUT`) || Method(`PATCH`))
      kind: Rule
      middlewares:
        - name: auth-required
      services:
        - name: urls-service
          port: 9091
      priority: 11

    # Public GET requests to API (no auth)
    - match: PathPrefix(`/api`) && (Method(`GET`) || Method(`HEAD`) || Method(`OPTIONS`))
      kind: Rule
      services:
        - name: urls-service
          port: 9091
      priority: 10

    # IAM endpoints (public - handles its own auth)
    - match: PathPrefix(`/auth`) || PathPrefix(`/users`)
      kind: Rule
      services:
        - name: iam-service
          port: 9092
      priority: 15

    # Frontend (catch-all)
    - match: PathPrefix(`/`)
      kind: Rule
      services:
        - name: urls-frontend
          port: 80
      priority: 1
